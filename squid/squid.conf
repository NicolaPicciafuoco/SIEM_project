# squid/squid.conf

# -------------------------------------------------
# Squid Transparent + FTP Intercept Proxy
# -------------------------------------------------

# 1) Porte in modalità trasparente
http_port 3128 intercept
ftp_port  21   intercept

# 2) Porte considerate “sicure” e metodi abilitati: SSL‐bump per HTTPS (se non ti serve un MITM vero, puoi limitarti a CONNECT)
# Abilita il CONNECT sui soli SSL_ports
acl SSL_ports    port 443
acl Safe_ports   port 80     # http
acl Safe_ports   port 21     # ftp
acl Safe_ports   port 443    # https
acl CONNECT      method CONNECT

# Permetti il CONNECT su SSL_ports (tunnel HTTPS)
http_access allow CONNECT SSL_ports

# -------------------------------------------------
# Qui inizia il nuovo blocco policy
# -------------------------------------------------

# 3) ACL “localnet” e permessi di default
#acl localnet src 10.10.0.0/16
#http_access allow localnet
#http_access deny all
acl net_guest        src 10.10.1.0/24
acl net_mgmt         src 10.10.2.0/24
acl net_eth          src 10.10.3.0/24
acl net_server       dst 10.10.4.0/24
acl net_internet     src 10.10.5.0/24


# ACL specifica per il guest2 (10.10.1.12)
acl guest2           src 10.10.1.12
# ACL specifica per il eth2 (10.10.3.12)
acl eth2             src 10.10.3.12

# 4) Metodi HTTP
acl Safe_Methods     method GET HEAD OPTIONS

# 5) Orari di lavoro e weekend
acl work_hours   time M T W H F 08:00-18:00
acl weekend      time S U 00:00-24:00

# 6) Whitelist di amministratori
acl whitelist        src 10.10.2.11 10.10.3.11

# -------------------------------------------------
# Regole di accesso basate sulle policy
# L’ordine è fondamentale: prima i permit specifici, poi il deny all
# -------------------------------------------------

# A) Il server è sempre raggiungibile
#http_access allow      net_server

# B) Gli IP in whitelist hanno accesso illimitato
http_access allow      whitelist

# C) Blocca fuori orario per guest e management
http_access deny       net_guest    !work_hours
http_access deny       net_guest    weekend


# D) Ma la whitelist è OK anche nei weekend
http_access allow      whitelist    weekend


# -------------------------------------------------
# 7) Blacklist di guest2 (dstdomain dal file ACL)
# -------------------------------------------------
http_access deny       guest2  
#  Blacklist di eth2 (dstdomain dal file ACL)
http_access deny       eth2

# E) Guest & Mgmt → Server solo Safe_Methods
http_access allow      net_guest    net_server Safe_Methods
http_access allow      net_mgmt     net_server Safe_Methods

# F) Ethernet → Server Safe_Methods + CONNECT per HTTPS
http_access allow      net_eth      net_server Safe_Methods
http_access allow      net_eth      CONNECT     SSL_ports

# G) Internet → Server Safe_Methods + CONNECT per HTTPS
http_access allow      net_internet net_server Safe_Methods
http_access allow      net_internet CONNECT     SSL_ports

# H) Tutto il resto viene negato
http_access deny       all

# -------------------------------------------------
# Fine blocco policy; di seguito le impostazioni standard
# -------------------------------------------------

# 7) Cache, log e permessi
cache_mem            256 MB
cache_dir            aufs /var/spool/squid 10000 16 256
max_filedescriptors  8192

access_log           /var/log/squid/access.log squid
cache_log            /var/log/squid/cache.log  squid
umask                022
