# squid/squid.conf

# -------------------------------------------------
# Squid Transparent + FTP Intercept Proxy
# -------------------------------------------------

# 1) Porte in modalità trasparente
http_port 3128 intercept        # Proxy HTTP trasparente su porta 3128
ftp_port  21   intercept        # Proxy FTP trasparente su porta 21

# 2) Definizione delle porte “sicure” e del metodo CONNECT per HTTPS
acl HTTP_port    port 80        # HTTP
acl FTP_port     port 21        # FTP
acl Safe_ports   port 443       # HTTPS
acl SSL_ports    port 443       # HTTPS per CONNECT
acl CONNECT      method CONNECT # Metodo HTTP CONNECT

# -------------------------------------------------
# Permetti solo la URL esatta
acl allowed_http80_urls url_regex -i ^http://10\.10\.4\.100/index\.html$

# 2.A) Blocca FTP (porta 21)
http_access deny FTP_port

# 2.B) Blocca HTTPS (CONNECT su 443)
http_access deny CONNECT SSL_ports

# 2.C) Permetti solo le URL su HTTP/80
# Permetti la home page (index.html e index.php)
acl allowed_homepage url_regex -i ^http://10\.10\.4\.100/(index\.html|index\.php)$

# Permetti tutte le chiamate al tuo endpoint /query?…
acl query_urls     url_regex -i ^http://10\.10\.4\.100/query\?.*$

# Applica le ACL prima del blocco generale
http_access allow allowed_homepage HTTP_port
http_access allow query_urls     HTTP_port

# 2.D) Blocca tutte le altre richieste HTTP/80
http_access deny HTTP_port

# -------------------------------------------------
# 3) Definizione delle reti/subnet
# -------------------------------------------------
acl net_guest        src 10.10.1.0/24  # Rete Guest
acl net_mgmt         src 10.10.2.0/24  # Rete Management
acl net_eth          src 10.10.3.0/24  # Rete Ethernet
acl net_server       dst 10.10.4.0/24  # Destinazioni nel Server Net
acl net_internet     src 10.10.5.0/24  # Rete Internet

# ACL individuali per casi speciali
acl guest2           src 10.10.1.12    # Container guest2
acl eth2             src 10.10.3.12    # Container eth2

# -------------------------------------------------
# 4) Metodi HTTP ammessi
# -------------------------------------------------
acl Safe_Methods     method GET HEAD OPTIONS

# -------------------------------------------------
# 5) ACL basate sul tempo
# -------------------------------------------------
acl work_hours       time M T W H F 08:00-18:00   # Orario lavorativo
acl weekend          time S U 00:00-24:00        # Fine settimana (Sab e Dom)

# -------------------------------------------------
# 6) Whitelist di amministratori
# -------------------------------------------------
#acl whitelist        src 10.10.2.11 10.10.3.11   # IP di utenti privilegiati (mgmt1 e eth1)

# -------------------------------------------------
# 7) Policy di accesso
#    (Valutate in ordine: prima i permit specifici, poi i deny generici)
# -------------------------------------------------

# 7.A) Bypass per gli amministratori
#http_access allow      whitelist

# 7.B) Anytime block per guest2 ed eth2
#http_access deny       guest2            # Blocca tutte le richieste di guest2
#http_access deny       eth2              # Blocca tutte le richieste di eth2

# 7.C) Blocchi fuori orario e fine settimana
http_access deny       net_guest    !work_hours  # Guest fuori orario
http_access deny       net_guest    weekend     # Guest nel weekend
http_access deny       net_mgmt     !work_hours  # Management fuori orario
http_access deny       net_mgmt     weekend     # Management nel weekend

# 7.D) Guest & Management → Solo server e solo GET/HEAD/OPTIONS
http_access allow      net_guest    net_server Safe_Methods
http_access allow      net_mgmt     net_server Safe_Methods

# 7.E) Ethernet → Server (HTTP/FTP) + tunnel HTTPS
http_access allow      net_eth      net_server Safe_Methods
http_access allow      net_eth      CONNECT     SSL_ports

# 7.F) Internet → Server (HTTP/FTP) + tunnel HTTPS
http_access allow      net_internet net_server Safe_Methods
http_access allow      net_internet CONNECT     SSL_ports

# 7.G) Tutte le altre richieste vanno bloccate
http_access deny       all

# -------------------------------------------------
# 8) Cache, log e permessi
# -------------------------------------------------
cache_mem            256 MB
cache_dir            aufs /var/spool/squid 10000 16 256
max_filedescriptors  8192

access_log           /var/log/squid/access.log squid
cache_log            /var/log/squid/cache.log  squid

# Imposta permessi di umask per i file di log
umask                022

# Aggiunta IP bloccati da policy

acl blocked_ips src "/etc/squid/blocked_ips.txt"
http_access deny blocked_ips
